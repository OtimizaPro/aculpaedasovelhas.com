name: Deploy WordPress Theme - A Culpa Ã© das Ovelhas

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      deploy_pages:
        description: 'Criar/Atualizar pÃ¡ginas WordPress'
        required: false
        default: 'true'
        type: boolean
      clear_cache:
        description: 'Limpar cache do WordPress'
        required: false
        default: 'true'
        type: boolean

env:
  THEME_NAME: aculpa-theme
  SITE_URL: https://aculpaedasovelhas.com

jobs:
  validate:
    name: ðŸ” Validate PHP & Structure
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
      
      - name: PHP Lint
        run: |
          find . -type f -name "*.php" ! -path "./vendor/*" -print0 | xargs -0 -I {} php -l {} | grep -v "No syntax errors" || true

      - name: Theme Checks
        run: |
          test -f style.css || (echo "âŒ style.css nÃ£o encontrado" && exit 1)
          grep -q "Theme Name:" style.css || (echo "âŒ CabeÃ§alho do tema ausente" && exit 1)
          echo "âœ… ValidaÃ§Ã£o concluÃ­da"

  build:
    name: ðŸ“¦ Build Theme Package
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Create ZIP
        run: |
          mkdir -p build
          zip -r build/${{ env.THEME_NAME }}.zip . \
            -x "*.git*" \
            -x ".github/*" \
            -x "build/*" \
            -x "node_modules/*" \
            -x "vendor/*" \
            -x ".venv/*" \
            -x "automation/*" \
            -x "*.md" \
            -x ".env*" \
            -x "__*"
      
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.THEME_NAME }}
          path: build/${{ env.THEME_NAME }}.zip
          retention-days: 7

  deploy-sftp:
    name: ðŸš€ Deploy via SFTP
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Install lftp
        run: sudo apt-get update && sudo apt-get install -y lftp

      - name: Deploy via SFTP
        run: |
          lftp -c "
            set sftp:auto-confirm yes
            set net:timeout 30
            set net:max-retries 3
            open -u '${{ secrets.WP_FTP_USERNAME }}','${{ secrets.WP_FTP_PASSWORD }}' sftp://${{ secrets.WP_FTP_SERVER }}:${{ secrets.WP_FTP_PORT }}
            mirror -R -v --parallel=4 \
              --exclude .git/ \
              --exclude .github/ \
              --exclude .venv/ \
              --exclude node_modules/ \
              --exclude automation/ \
              --exclude __blobstorage__/ \
              --exclude __queuestorage__/ \
              --exclude .env \
              . ${{ secrets.WP_FTP_REMOTE_DIR }}
            bye
          "
      
      - name: Verify Deployment
        run: |
          echo "ðŸ” Verificando deploy..."
          sleep 5
          response=$(curl -s -o /dev/null -w "%{http_code}" "${{ env.SITE_URL }}")
          if [ "$response" = "200" ]; then
            echo "âœ… Site respondendo (HTTP $response)"
          else
            echo "âš ï¸ Site retornou HTTP $response"
          fi

  create-wp-pages:
    name: ðŸ“„ Create WordPress Pages
    runs-on: ubuntu-latest
    needs: deploy-sftp
    if: github.event.inputs.deploy_pages == 'true' || github.event_name == 'push'
    steps:
      - name: Create Pages via REST API
        run: |
          AUTH=$(echo -n "${{ secrets.WP_ADMIN_USER }}:${{ secrets.WP_APP_PASSWORD }}" | base64)
          
          pages=(
            "o-livrinho:O Livrinho"
            "manifesto:Manifesto"
            "biblia:BÃ­blia Online"
            "artigos:Artigos"
            "o-autor:O Autor"
            "painel:Painel"
            "an-agent:AN Agent"
          )
          
          for page in "${pages[@]}"; do
            slug="${page%%:*}"
            title="${page#*:}"
            
            # Verificar se pÃ¡gina existe
            existing=$(curl -s -H "Authorization: Basic $AUTH" \
              "${{ env.SITE_URL }}/wp-json/wp/v2/pages?slug=$slug")
            
            if [ "$existing" = "[]" ]; then
              echo "ðŸ“„ Criando pÃ¡gina: $title ($slug)"
              curl -s -X POST \
                -H "Authorization: Basic $AUTH" \
                -H "Content-Type: application/json" \
                -d "{\"title\":\"$title\",\"slug\":\"$slug\",\"status\":\"publish\",\"content\":\"\"}" \
                "${{ env.SITE_URL }}/wp-json/wp/v2/pages" > /dev/null
              echo "âœ… PÃ¡gina criada: $title"
            else
              echo "â„¹ï¸ PÃ¡gina jÃ¡ existe: $title"
            fi
          done

  clear-cache:
    name: ðŸ§¹ Clear WordPress Cache
    runs-on: ubuntu-latest
    needs: [deploy-sftp, create-wp-pages]
    if: always() && (github.event.inputs.clear_cache == 'true' || github.event_name == 'push')
    steps:
      - name: Trigger Cache Clear
        run: |
          # Tentar limpar cache via endpoint customizado (se existir)
          curl -s -X POST \
            -H "Authorization: Basic $(echo -n '${{ secrets.WP_ADMIN_USER }}:${{ secrets.WP_APP_PASSWORD }}' | base64)" \
            "${{ env.SITE_URL }}/wp-json/wp/v2/settings" > /dev/null 2>&1 || true
          
          # Fazer request para forÃ§ar atualizaÃ§Ã£o
          curl -s -H "Cache-Control: no-cache" "${{ env.SITE_URL }}/?nocache=$(date +%s)" > /dev/null
          echo "âœ… Cache refresh solicitado"

  validate-deployment:
    name: âœ… Validate Deployment
    runs-on: ubuntu-latest
    needs: [deploy-sftp, create-wp-pages, clear-cache]
    if: always()
    steps:
      - name: Test All Pages
        run: |
          echo "ðŸ” Validando pÃ¡ginas..."
          
          pages=("/" "/o-livrinho" "/manifesto" "/artigos" "/biblia")
          all_passed=true
          
          for page in "${pages[@]}"; do
            response=$(curl -s -o /dev/null -w "%{http_code}" "${{ env.SITE_URL }}$page")
            if [ "$response" = "200" ]; then
              echo "âœ… $page (HTTP $response)"
            else
              echo "âŒ $page (HTTP $response)"
              all_passed=false
            fi
          done
          
          if [ "$all_passed" = false ]; then
            echo "âš ï¸ Algumas pÃ¡ginas nÃ£o estÃ£o acessÃ­veis"
            exit 1
          fi
          
          echo ""
          echo "ðŸŽ‰ Deploy concluÃ­do com sucesso!"
          echo "ðŸŒ Site: ${{ env.SITE_URL }}"

  notify:
    name: ðŸ“¢ Notify
    runs-on: ubuntu-latest
    needs: validate-deployment
    if: always()
    steps:
      - name: Create Summary
        run: |
          echo "## ðŸš€ Deploy Report - A Culpa Ã© das Ovelhas" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ” ValidaÃ§Ã£o | ${{ needs.validate.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“¦ Build | ${{ needs.build.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸš€ SFTP Deploy | ${{ needs.deploy-sftp.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“„ WP Pages | ${{ needs.create-wp-pages.result == 'success' && 'âœ…' || 'â­ï¸' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| âœ… Validation | ${{ needs.validate-deployment.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Site:** ${{ env.SITE_URL }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
