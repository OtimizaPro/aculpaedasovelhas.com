name: Deploy WordPress Theme

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  validate:
    name: Validate PHP & Structure
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
      
      - name: Install Composer Dependencies
        run: |
          if [ -f composer.json ]; then
            composer install --no-interaction --prefer-dist
          fi
      
      - name: PHP Lint
        run: |
          find . -type f -name "*.php" ! -path "./vendor/*" -print0 | xargs -0 -I {} php -l {} | grep -v "No syntax errors" || true

      - name: Basic Theme Checks
        run: |
          test -f style.css || (echo "style.css não encontrado" && exit 1)
          grep -q "Theme Name:" style.css || (echo "Cabeçalho do tema ausente em style.css" && exit 1)

  build:
    name: Build Theme Package
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Create ZIP
        run: |
          mkdir -p build
          zip -r build/otimiza-an-theme.zip . -x "*.git*" -x ".github/*" -x "build/*" -x "node_modules/*" -x "vendor/*"
      
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: otimiza-an-theme
          path: build/otimiza-an-theme.zip

  deploy-ftp:
    name: Deploy via SFTP
    runs-on: ubuntu-latest
    needs: build
    if: ${{ github.ref == 'refs/heads/main' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Download Artifact
        uses: actions/download-artifact@v4
        with:
          name: otimiza-an-theme
          path: build
      
      - name: Extract ZIP
        run: unzip build/otimiza-an-theme.zip -d extracted
      
      - name: Install lftp
        run: sudo apt-get update && sudo apt-get install -y lftp

      - name: Deploy via SFTP
        run: |
          cd extracted
          lftp -c "set sftp:auto-confirm yes; open -u '${{ secrets.WP_FTP_USERNAME }}','${{ secrets.WP_FTP_PASSWORD }}' sftp://${{ secrets.WP_FTP_SERVER }}:${{ secrets.WP_FTP_PORT }}; mirror -R -v --parallel=2 . ${{ secrets.WP_FTP_REMOTE_DIR }}; bye"

  build-docker:
    name: Build & Push Docker Image
    runs-on: ubuntu-latest
    needs: validate
    if: ${{ github.ref == 'refs/heads/main' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      
      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ secrets.DOCKER_USERNAME }}/otimiza-an-theme
          tags: |
            type=ref,event=branch
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}
      
      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=registry,ref=${{ secrets.DOCKER_USERNAME }}/otimiza-an-theme:buildcache
          cache-to: type=registry,ref=${{ secrets.DOCKER_USERNAME }}/otimiza-an-theme:buildcache,mode=max

# Instruções de Secrets:
# WP_FTP_SERVER       -> host FTP/FTPS
# WP_FTP_USERNAME     -> usuário
# WP_FTP_PASSWORD     -> senha
# WP_FTP_REMOTE_DIR   -> diretório remoto onde o WordPress espera a pasta do tema (ex: wp-content/themes/otimiza-an-theme/)
# WP_FTP_PORT         -> porta (opcional, default 21)
# WP_SSH_HOST         -> host SSH (para rsync)
# WP_SSH_USER         -> usuário SSH
# WP_SSH_KEY          -> chave privada SSH (sem senha)
# WP_SSH_REMOTE_DIR   -> diretório remoto do tema
